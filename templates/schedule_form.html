{% extends "base.html" %}

{% block title %}{% if schedule %}일정 수정{% else %}새 일정{% endif %} - 부산퀴어행동{% endblock %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<div class="detail-header">
    <a href="{{ url_for('schedules') }}" class="detail-back">← 목록</a>
    <h1 class="detail-title">{% if schedule %}일정 수정{% else %}새 일정{% endif %}</h1>
</div>

<form id="scheduleForm"
    action="{% if schedule %}{{ url_for('schedule_edit', schedule_id=schedule.id) }}{% else %}{{ url_for('schedule_add') }}{% endif %}"
    method="post" class="form-card">

    <div class="form-group">
        <label>일정명 <span class="required">*</span></label>
        <input type="text" name="title"
            value="{{ form_data.title if form_data else (schedule.title if schedule else '') }}"
            placeholder="예: 2026 부산퀴어문화축제" required>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label>날짜 <span class="optional">선택</span></label>
            <input type="text" name="date"
                value="{{ form_data.date if form_data else (schedule.date if schedule else '') }}"
                placeholder="예: 2026-03-15">
            <span class="form-hint">YYYY-MM-DD, YYYY-MM, YYYY-MM-초/중순/말, 연중</span>
        </div>
        <div class="form-group">
            <label>분류 <span class="required">*</span></label>
            <select name="category" required>
                <option value="">선택</option>
                {% set current_category = form_data.category if form_data else (schedule.category if schedule else '')
                %}
                <option value="정기모임" {% if current_category=='정기모임' %}selected{% endif %}>정기모임</option>
                <option value="정기모임 연계활동" {% if current_category=='정기모임 연계활동' %}selected{% endif %}>정기모임 연계활동</option>
                <option value="연대사업" {% if current_category=='연대사업' %}selected{% endif %}>연대사업</option>
                <option value="의결기관" {% if current_category=='의결기관' %}selected{% endif %}>의결기관</option>
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label>시작 시간 <span class="optional">선택</span></label>
            {% set start_time = form_data.start_time if form_data else (schedule.start_time if schedule and 'start_time'
            in schedule.keys() else '') %}
            <input type="time" name="start_time" value="{{ start_time or '' }}">
        </div>
        <div class="form-group">
            <label>종료 시간 <span class="optional">선택</span></label>
            {% set end_time = form_data.end_time if form_data else (schedule.end_time if schedule and 'end_time' in
            schedule.keys() else '') %}
            <input type="time" name="end_time" value="{{ end_time or '' }}">
        </div>
    </div>

    <div class="form-group">
        <label>장소 <span class="optional">선택</span></label>
        {% set location = form_data.location if form_data else (schedule.location if schedule and 'location' in
        schedule.keys() else '') %}
        <input type="text" name="location" value="{{ location or '' }}" placeholder="예: 부산시민회관 소강당">
    </div>

    <div class="form-row">
        <div class="form-group">
            <label class="check-label">
                {% set is_confirmed = form_data.is_confirmed if form_data else (schedule.is_confirmed if schedule else
                False) %}
                <input type="checkbox" name="is_confirmed" {% if is_confirmed %}checked{% endif %}>
                확정된 일정
            </label>
            <span class="form-hint">미확정 시 1달 전부터 TODO에 알림 표시</span>
        </div>
        <div class="form-group">
            <label class="check-label">
                {% set needs_prep = form_data.needs_advance_prep if form_data else (schedule.needs_advance_prep if
                schedule and 'needs_advance_prep' in schedule.keys() else False) %}
                <input type="checkbox" name="needs_advance_prep" {% if needs_prep %}checked{% endif %}>
                사전준비 필요
            </label>
            <span class="form-hint">체크 시 미확정 일정일 경우, 2달 전부터 알림</span>
        </div>
    </div>

    <div class="form-group">
        <label>세부내용 <span class="optional">선택</span></label>
        <div id="editor"></div>
        <input type="hidden" id="details" name="details">
    </div>

    <div class="form-actions">
        <button type="submit" class="btn primary">{% if schedule %}저장{% else %}추가{% endif %}</button>
        <a href="{{ url_for('schedules') }}" class="btn secondary">취소</a>
    </div>
</form>

<style>
    #editor {
        height: 200px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
    }

    .ql-toolbar {
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        background: var(--bg-2);
    }

    .ql-container {
        border-radius: 0 0 8px 8px;
        font-size: 15px;
    }

    @media (min-width: 768px) {
        #editor {
            height: 350px;
        }
    }
</style>

<script>
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['clean']
            ]
        },
        placeholder: '세부내용 입력...'
    });

    {% set details_content = form_data.details if form_data else (schedule.details if schedule else '') %}
    {% if details_content %}
    quill.root.innerHTML = {{ details_content | tojson | safe }};
    {% endif %}

    document.getElementById('scheduleForm').addEventListener('submit', function () {
        document.getElementById('details').value = quill.root.innerHTML;
    });
</script>
{% endblock %}