{% extends "base.html" %}

{% block title %}ì‹¤ë¬´ - ë¶€ì‚°í€´ì–´í–‰ë™ TODO{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ì‹¤ë¬´</h1>
    <p class="page-subtitle">ëª¨ë“  ì¼ì •ì˜ ì‹¤ë¬´ë¥¼ í•œ ê³³ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
</div>

<!-- í•„í„° ì„¤ëª… -->
<div class="filter-bar">
    <div class="tabs" style="margin-bottom: 0;">
        <a href="{{ url_for('tasks', show_completed='1', activist=filter_activist, month=filter_month) }}"
           class="tab {% if show_completed %}active{% endif %}" title="ì™„ë£Œëœ ì‹¤ë¬´ í¬í•¨">ì „ì²´</a>
        <a href="{{ url_for('tasks', show_completed='0', activist=filter_activist, month=filter_month) }}"
           class="tab {% if not show_completed %}active{% endif %}" title="ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€ ì‹¤ë¬´ë§Œ">ì˜ˆì •</a>
    </div>

    <select class="filter-select" onchange="applyFilter('activist', this.value)" title="íŠ¹ì • ë‹´ë‹¹ìì˜ ì‹¤ë¬´ë§Œ ë³´ê¸°">
        <option value="">ëª¨ë“  ë‹´ë‹¹ì</option>
        {% for activist in activists %}
        <option value="{{ activist.id }}" {% if filter_activist == activist.id %}selected{% endif %}>{{ activist.name }}</option>
        {% endfor %}
    </select>

    <select class="filter-select" onchange="applyFilter('month', this.value)" title="íŠ¹ì • ì›”ì˜ ë§ˆê° ì‹¤ë¬´ë§Œ ë³´ê¸°">
        <option value="">ëª¨ë“  ê¸°ê°„</option>
        {% for month in months %}
        <option value="{{ month }}" {% if filter_month == month %}selected{% endif %}>{{ month }}</option>
        {% endfor %}
    </select>
</div>

<!-- í˜„ì¬ í•„í„° ìƒíƒœ í‘œì‹œ -->
{% if filter_activist or filter_month %}
<div class="filter-status">
    <span class="filter-status-label">ì ìš©ëœ í•„í„°:</span>
    {% if filter_activist %}
    <span class="filter-tag">
        ë‹´ë‹¹ì: {% for a in activists %}{% if a.id == filter_activist %}{{ a.name }}{% endif %}{% endfor %}
        <a href="{{ url_for('tasks', show_completed='1' if show_completed else '0', month=filter_month) }}" class="filter-remove" title="í•„í„° í•´ì œ">Ã—</a>
    </span>
    {% endif %}
    {% if filter_month %}
    <span class="filter-tag">
        ê¸°ê°„: {{ filter_month }}
        <a href="{{ url_for('tasks', show_completed='1' if show_completed else '0', activist=filter_activist) }}" class="filter-remove" title="í•„í„° í•´ì œ">Ã—</a>
    </span>
    {% endif %}
</div>
{% endif %}

{% if grouped_tasks %}
{% for month, tasks in grouped_tasks.items() %}
<div class="month-group">
    <div class="month-header">{{ month }} <span class="month-count">({{ tasks|length }}ê±´)</span></div>
    <ul class="task-list">
        {% for task in tasks %}
        <li class="task-item {% if task.is_completed %}completed{% endif %}" data-task-id="{{ task.id }}">
            <button type="button" class="checkbox-btn {% if task.is_completed %}checked{% endif %}" onclick="toggleTask({{ task.id }}, this)" title="í´ë¦­í•˜ì—¬ ì™„ë£Œ/ë¯¸ì™„ë£Œ ì „í™˜">
                {% if task.is_completed %}âœ“{% endif %}
            </button>
            <div class="task-content">
                <div class="task-text">
                    {% if task.is_draft %}<span class="badge badge-draft" title="ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ì‹¤ë¬´">ê°€ì•ˆ</span> {% endif %}
                    {{ task.content }}
                </div>
                <div class="task-meta">
                    <a href="{{ url_for('schedule_detail', schedule_id=task.schedule_id) }}" class="schedule-link" title="ì—°ê²°ëœ ì¼ì • ë³´ê¸°">{{ task.schedule_title }}</a>
                    {% if task.is_idea %}
                    <span class="badge badge-idea" title="ì‹¤ë¬´ê°€ ì•„ë‹Œ ì•„ì´ë””ì–´">ì•„ì´ë””ì–´</span>
                    {% endif %}
                    {% if task.deadline and not task.is_completed %}
                    <span class="deadline-date">{{ task.deadline | date_kr }}</span>
                    <span class="dday {{ task.dday_class }}">{{ task.dday_text }}</span>
                    {% endif %}
                    {% if task.activist_name %}
                    <span class="assignee" title="ë‹´ë‹¹ì">{{ task.activist_name }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="task-actions">
                <button type="button" class="btn btn-ghost btn-sm" onclick="openEditModal({{ task.id }}, `{{ task.content | replace('`', '\\`') | replace('\n', '\\n') }}`, '{{ task.activist_id or '' }}', '{{ task.deadline or '' }}', {{ task.is_draft }}, {{ task.is_idea }})">ìˆ˜ì •</button>
                <form action="{{ url_for('task_delete', task_id=task.id) }}" method="post" class="inline-form"
                      onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit" class="btn btn-danger btn-sm">ì‚­ì œ</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>
{% endfor %}
{% else %}
<div class="empty-state">
    <div class="empty-icon">ğŸ“</div>
    <div class="empty-message">
        {% if filter_activist or filter_month %}
        ì¡°ê±´ì— ë§ëŠ” ì‹¤ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤
        {% else %}
        ë“±ë¡ëœ ì‹¤ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤
        {% endif %}
    </div>
    <div class="empty-hint">
        {% if filter_activist or filter_month %}
        ë‹¤ë¥¸ í•„í„°ë¥¼ ì„ íƒí•˜ê±°ë‚˜ <a href="{{ url_for('tasks') }}">ì „ì²´ ë³´ê¸°</a>ë¥¼ í´ë¦­í•˜ì„¸ìš”
        {% else %}
        ì•„ë˜ ì–‘ì‹ìœ¼ë¡œ ìƒˆ ì‹¤ë¬´ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜, ì¼ì • ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        {% endif %}
    </div>
</div>
{% endif %}

<!-- ì‹¤ë¬´ ì¶”ê°€ -->
<div class="section mt-4">
    <div class="section-header">
        <div class="section-title">â• ì‹¤ë¬´ ì¶”ê°€</div>
    </div>
    <p class="section-description">ìƒˆë¡œìš´ ì‹¤ë¬´ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. ì¼ì • ìƒì„¸ í˜ì´ì§€ì—ì„œë„ ì‹¤ë¬´ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <form id="task-form" action="{{ url_for('task_add') }}" method="post" class="form-card">
        <input type="hidden" name="referer" value="{{ request.url }}">
        <input type="hidden" id="selected-schedule-id" name="schedule_id" value="">
        <input type="hidden" id="selected-activist-id" name="activist_id" value="">

        <div class="form-row">
            <div class="form-group">
                <label>ì—°ê²° ì¼ì • <span class="required">*</span></label>
                <button type="button" class="form-control" style="text-align: left; cursor: pointer;" onclick="openModal('schedule-modal')" title="ì´ ì‹¤ë¬´ê°€ ì†í•œ ì¼ì •ì„ ì„ íƒí•˜ì„¸ìš”">
                    <span id="selected-schedule-text">ì„ íƒí•˜ì„¸ìš”</span>
                </button>
                <span class="form-hint">ì‹¤ë¬´ê°€ ì†í•œ ì¼ì •ì„ ì„ íƒí•˜ì„¸ìš”</span>
            </div>
            <div class="form-group" style="flex: 2;">
                <label>ì‹¤ë¬´ ë‚´ìš© <span class="required">*</span></label>
                <input type="text" name="content" class="form-control" placeholder="ì˜ˆ: í¬ìŠ¤í„° ë””ìì¸í•˜ê¸°, ì¥ì†Œ ëŒ€ê´€í•˜ê¸°" required>
                <span class="form-hint">í•´ì•¼ í•  ì¼ì„ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”</span>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>ë‹´ë‹¹ì</label>
                <button type="button" class="form-control" style="text-align: left; cursor: pointer;" onclick="openModal('activist-modal')" title="ì´ ì‹¤ë¬´ì˜ ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”">
                    <span id="selected-activist-text">ë¯¸ì§€ì •</span>
                </button>
                <span class="form-hint">ì„ íƒ ì‚¬í•­</span>
            </div>
            <div class="form-group">
                <label>ë§ˆê°ì¼</label>
                <input type="date" name="deadline" class="form-control" title="ì´ ì‹¤ë¬´ë¥¼ ì™„ë£Œí•´ì•¼ í•˜ëŠ” ë‚ ì§œ">
                <span class="form-hint">ì–¸ì œê¹Œì§€ ì™„ë£Œí•´ì•¼ í•˜ë‚˜ìš”?</span>
            </div>
            <div class="form-group">
                <label class="form-check" title="ì„¸ë¶€ë‚´ìš©ì— ëŒ€í•œ ì•„ì´ë””ì–´ì¸ ê²½ìš° ì²´í¬">
                    <input type="checkbox" name="is_idea">
                    ì•„ì´ë””ì–´
                </label>
                <span class="form-hint">ì„¸ë¶€ë‚´ìš© ì•„ì´ë””ì–´</span>
            </div>
            <div class="form-group">
                <label class="form-check" title="ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ì‹¤ë¬´ì¸ ê²½ìš° ì²´í¬">
                    <input type="checkbox" name="is_draft">
                    ê°€ì•ˆ
                </label>
                <span class="form-hint">ë¯¸í™•ì • ì‹¤ë¬´</span>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
        </div>
    </form>
</div>

<!-- ì¼ì • ì„ íƒ ëª¨ë‹¬ -->
<div id="schedule-modal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'schedule-modal')">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ì¼ì • ì„ íƒ</span>
            <button class="modal-close" onclick="closeModal('schedule-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p class="modal-hint">ì´ ì‹¤ë¬´ê°€ ì†í•œ ì¼ì •ì„ ì„ íƒí•˜ì„¸ìš”</p>
            <div class="select-list">
                {% for schedule in schedules %}
                <div class="select-item" onclick="selectSchedule('{{ schedule.id }}', '{{ schedule.title }}')">
                    <div class="select-item-info">
                        <div class="select-item-name">{{ schedule.title }}</div>
                        <div class="select-item-detail">{{ schedule.category }} Â· {{ schedule.date | date_kr }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- ë‹´ë‹¹ì ì„ íƒ ëª¨ë‹¬ -->
<div id="activist-modal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'activist-modal')">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ë‹´ë‹¹ì ì„ íƒ</span>
            <button class="modal-close" onclick="closeModal('activist-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p class="modal-hint">ì´ ì‹¤ë¬´ì˜ ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
            <div class="select-list">
                <div class="select-item" onclick="selectActivist('', 'ë¯¸ì§€ì •')">
                    <div class="select-item-avatar">-</div>
                    <div class="select-item-info">
                        <div class="select-item-name">ë¯¸ì§€ì •</div>
                        <div class="select-item-detail">ë‹´ë‹¹ìë¥¼ ë‚˜ì¤‘ì— ì •í•©ë‹ˆë‹¤</div>
                    </div>
                </div>
                {% for activist in activists %}
                <div class="select-item" onclick="selectActivist('{{ activist.id }}', '{{ activist.name }}')">
                    <div class="select-item-avatar">{{ activist.name[0] }}</div>
                    <div class="select-item-info">
                        <div class="select-item-name">{{ activist.name }}</div>
                        <div class="select-item-detail">ID: {{ activist.id }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal" class="edit-modal" style="display: none;">
    <div class="edit-modal-backdrop" onclick="closeEditModal()"></div>
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h3 class="edit-modal-title">ì‹¤ë¬´ ìˆ˜ì •</h3>
            <button type="button" class="edit-modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm" method="post">
            <div class="edit-modal-body">
                <div class="form-group">
                    <label>ë‚´ìš©</label>
                    <input type="text" name="content" id="editContent" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>ë‹´ë‹¹ì</label>
                    <select name="activist_id" id="editActivist" class="form-control">
                        <option value="">ë¯¸ì •</option>
                        {% for activist in activists %}
                        <option value="{{ activist.id }}">{{ activist.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" id="deadlineGroup">
                    <label>ë§ˆê°ì¼</label>
                    <input type="date" name="deadline" id="editDeadline" class="form-control">
                </div>
                <div class="form-group" id="draftGroup">
                    <label class="form-check">
                        <input type="checkbox" name="is_draft" id="editDraft" value="1">
                        ê°€ì•ˆ (ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ì‹¤ë¬´)
                    </label>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </div>
        </form>
    </div>
</div>

<style>
.edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.edit-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}
.edit-modal-content {
    position: relative;
    background: var(--bg-main);
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
}
.edit-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}
.edit-modal-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}
.edit-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
}
.edit-modal-body {
    padding: 20px;
}
.edit-modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}
</style>

<script>
function applyFilter(key, value) {
    const url = new URL(window.location.href);
    if (value) {
        url.searchParams.set(key, value);
    } else {
        url.searchParams.delete(key);
    }
    window.location.href = url.toString();
}

function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function closeModalOnOverlay(event, id) {
    if (event.target.classList.contains('modal-overlay')) {
        closeModal(id);
    }
}

function selectSchedule(id, title) {
    document.getElementById('selected-schedule-id').value = id;
    document.getElementById('selected-schedule-text').textContent = title;
    closeModal('schedule-modal');
}

function selectActivist(id, name) {
    document.getElementById('selected-activist-id').value = id;
    document.getElementById('selected-activist-text').textContent = name;
    closeModal('activist-modal');
}

function openEditModal(taskId, content, activistId, deadline, isDraft, isIdea) {
    document.getElementById('editForm').action = `/task/${taskId}/edit`;
    document.getElementById('editContent').value = content;
    document.getElementById('editActivist').value = activistId || '';
    document.getElementById('editDeadline').value = deadline || '';
    document.getElementById('editDraft').checked = isDraft == 1;

    // ì•„ì´ë””ì–´ì¸ ê²½ìš° ë§ˆê°ì¼ê³¼ ê°€ì•ˆ ì˜µì…˜ ìˆ¨ê¸°ê¸°
    document.getElementById('deadlineGroup').style.display = isIdea ? 'none' : 'block';
    document.getElementById('draftGroup').style.display = isIdea ? 'none' : 'block';

    document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
    }
});
</script>
{% endblock %}
