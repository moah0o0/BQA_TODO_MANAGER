{% extends "base.html" %}

{% block title %}TODO - ë¶€ì‚°í€´ì–´í–‰ë™{% endblock %}

{% block content %}
<!-- ì‚¬ì „ì¤€ë¹„ ì•Œë¦¼ -->
{% if prep_reminders %}
<section class="section">
    {% for reminder in prep_reminders %}
    <div class="reminder-card {% if not reminder.is_advance_prep %}regular{% endif %}">
        <span class="reminder-icon">ğŸ“¢</span>
        <div class="reminder-content">
            <div class="reminder-title">{{ reminder.title }}</div>
            <div class="reminder-text">{{ reminder.date | date_kr }} Â· {% if reminder.is_advance_prep %}2ë‹¬ ì „ë¶€í„° ì‚¬ì „ì¤€ë¹„ë¥¼ í•´ì•¼
                í•˜ëŠ” ì‚¬ì—…ì…ë‹ˆë‹¤. ì•„ì´ë””ì–´ ê³ ë¯¼ê³¼ ë…¼ì˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”{% else %}1ë‹¬ ì´ë‚´ì˜ ì¼ì •ì¸ë° ê¸°íšì´ í™•ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.{% endif %}</div>
            {% if reminder.idea_count %}<div class="reminder-ideas">ğŸ’¡ ì•„ì´ë””ì–´ {{ reminder.idea_count }}ê±´</div>{% endif %}
        </div>
        <a href="{{ url_for('schedule_detail', schedule_id=reminder.id) }}" class="btn secondary">ë³´ê¸°</a>
    </div>
    {% endfor %}
</section>
{% endif %}

<!-- í•„í„° ë°” -->
<div class="filter-bar">
    <div class="activist-tabs">
        {% for activist in activists %}
        <a href="{{ url_for('index', activist=activist.id, show_completed='1' if show_completed else '0') }}"
           class="activist-tab {% if filter_activist == activist.id %}active{% endif %}">{{ activist.name }}</a>
        {% endfor %}
        <a href="{{ url_for('index', activist='', show_completed='1' if show_completed else '0') }}"
           class="activist-tab {% if filter_activist == '' %}active{% endif %}">ì „ì²´</a>
    </div>
    <label class="filter-toggle">
        <input type="checkbox"
            onchange="location.href='{{ url_for('index', activist=filter_activist, show_completed='0' if show_completed else '1') }}'"
            {% if show_completed %}checked{% endif %}>
        <span>ì™„ë£Œ</span>
    </label>
</div>

<!-- TODO í—¤ë” -->
<div class="todo-header">
    <span class="todo-count">{{ all_tasks|length }}ê°œ</span>
</div>
    {% if all_tasks %}
    <div class="task-list">
        {% for task in all_tasks %}
        <div class="task-row {% if task.is_completed %}done{% endif %}{% if task in urgent_tasks %} urgent{% endif %}{% if task.is_mine and filter_activist == '' %} mine{% endif %}" data-id="{{ task.id }}">
            <button type="button" class="checkbox" onclick="toggleTask({{ task.id }}, this)">{% if task.is_completed
                %}âœ“{% endif %}</button>
            <div class="task-info"
                onclick="openEdit({{ task.id }}, `{{ task.content | replace('`', '\\`') }}`, '{{ task.activist_id or '' }}', '{{ task.deadline or '' }}', '{{ task.schedule_id or '' }}')">
                <span class="task-text">{{ task.content }}</span>
                <div class="task-details">
                    {% if task in urgent_tasks and not task.is_completed %}<span class="tag urgent">ğŸ”¥ ê¸‰í•¨</span>{% endif %}
                    {% if task.deadline %}<span class="tag deadline">{{ task.deadline | date_kr }}ê¹Œì§€</span>{% endif %}
                    {% if task.dday_text %}<span class="dday {{ task.dday_class }}">{{ task.dday_text }}</span>{% endif %}
                    {% if task.activist_name %}<span class="assignee {% if task.is_mine and filter_activist == '' %}mine{% endif %}">{{ task.activist_name }}</span>{% else %}<span class="assignee unassigned">ë¯¸ì •</span>{% endif %}
                </div>
                {% if task.schedule_title %}
                <a href="{{ url_for('schedule_detail', schedule_id=task.schedule_id) }}" class="task-schedule"
                    onclick="event.stopPropagation()">
                    <span class="task-schedule-icon">ğŸ“…</span>
                    <span class="task-schedule-info">
                        <span class="task-schedule-title">{{ task.schedule_title }}</span>
                        {% if task.schedule_date %}<span class="task-schedule-date">{{ task.schedule_date | date_kr
                            }}</span>{% endif %}
                    </span>
                </a>
                {% endif %}
            </div>
            <form action="{{ url_for('task_delete', task_id=task.id) }}" method="post" onsubmit="return confirm('ì‚­ì œ?')">
                <button type="submit" class="btn-icon delete">Ã—</button>
            </form>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty">
        <p>TODOê°€ ì—†ìŠµë‹ˆë‹¤</p>
        <p class="hint">ì•„ë˜ + ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”</p>
    </div>
    {% endif %}
</section>

<!-- FAB (í”Œë¡œíŒ… ì¶”ê°€ ë²„íŠ¼) -->
<button type="button" class="fab" onclick="openAdd()">
    <span>+</span>
</button>

<!-- ì¶”ê°€/ìˆ˜ì • ë°”í…€ì‹œíŠ¸ -->
<div id="sheet" class="sheet">
    <div class="sheet-bg" onclick="closeSheet()"></div>
    <div class="sheet-content">
        <div class="sheet-handle"></div>
        <form id="taskForm" action="{{ url_for('task_add') }}" method="post">
            <input type="hidden" name="referer" value="{{ request.url }}">

            <div class="sheet-input-main">
                <input type="text" id="formContent" name="content" placeholder="ë¬´ì—‡ì„ í•´ì•¼ í•˜ë‚˜ìš”?" required
                    autocomplete="off">
            </div>

            <div class="sheet-options">
                <button type="button" class="sheet-option" onclick="toggleOption('assignee')">
                    <span class="sheet-option-icon">ğŸ‘¤</span>
                    <span id="assigneeLabel">ë‹´ë‹¹ì</span>
                </button>
                <button type="button" class="sheet-option" onclick="toggleOption('deadline')">
                    <span class="sheet-option-icon">ğŸ“…</span>
                    <span id="deadlineLabel">ë§ˆê°ì¼</span>
                </button>
                <button type="button" class="sheet-option" onclick="toggleOption('schedule')">
                    <span class="sheet-option-icon">ğŸ“‹</span>
                    <span id="scheduleLabel">ì¼ì •</span>
                </button>
            </div>

            <!-- ìˆ¨ê²¨ì§„ ì˜µì…˜ íŒ¨ë„ë“¤ -->
            <div id="optionAssignee" class="sheet-panel" style="display:none;">
                <select id="formActivist" name="activist_id" onchange="updateAssigneeLabel()">
                    <option value="">ë‹´ë‹¹ì ì—†ìŒ</option>
                    {% for activist in activists %}
                    <option value="{{ activist.id }}">{{ activist.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="optionDeadline" class="sheet-panel" style="display:none;">
                <div class="date-picker">
                    <div class="date-picker-header">
                        <button type="button" onclick="changeMonth(-1)">â€¹</button>
                        <span id="calendarMonth"></span>
                        <button type="button" onclick="changeMonth(1)">â€º</button>
                    </div>
                    <div class="date-picker-weekdays">
                        <span>ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span>
                    </div>
                    <div id="calendarDays" class="date-picker-days"></div>
                    <div class="quick-dates">
                        <button type="button" onclick="setQuickDate(0)">ì˜¤ëŠ˜</button>
                        <button type="button" onclick="setQuickDate(1)">ë‚´ì¼</button>
                        <button type="button" onclick="setQuickDate(7)">1ì£¼</button>
                        <button type="button" onclick="clearDate()">ì—†ìŒ</button>
                    </div>
                </div>
                <input type="hidden" id="formDeadline" name="deadline" value="">
            </div>

            <div id="optionSchedule" class="sheet-panel" style="display:none;">
                <div class="schedule-picker">
                    <div class="schedule-picker-item none" onclick="selectSchedule('', 'ì—†ìŒ')">
                        <span class="schedule-picker-icon">âœ•</span>
                        <span>ì—°ê²° ì•ˆí•¨</span>
                    </div>
                    {% set current_month = namespace(value='') %}
                    {% for schedule in schedules %}
                    {% set schedule_month = schedule.date[:7] if schedule.date and schedule.date|length >= 7 else 'ë‚ ì§œ
                    ë¯¸ì •' %}
                    {% if schedule_month != current_month.value %}
                    {% set current_month.value = schedule_month %}
                    <div class="schedule-picker-month">
                        {% if schedule_month == 'ë‚ ì§œ ë¯¸ì •' %}
                        ë‚ ì§œ ë¯¸ì •
                        {% else %}
                        {{ schedule_month[:4] }}ë…„ {{ schedule_month[5:7]|int }}ì›”
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="schedule-picker-item"
                        onclick="selectSchedule('{{ schedule.id }}', '{{ schedule.title }}')"
                        data-schedule-id="{{ schedule.id }}">
                        <div class="schedule-picker-date">
                            {% if schedule.date and schedule.date|length >= 10 %}
                            <span class="day">{{ schedule.date[8:10]|int }}</span>
                            <span class="weekday">{{ schedule.date | weekday_kr }}</span>
                            {% else %}
                            <span class="day">-</span>
                            {% endif %}
                        </div>
                        <div class="schedule-picker-info">
                            <span class="schedule-picker-title">{{ schedule.title }}</span>
                            <span class="schedule-picker-meta">
                                <span class="badge small">{{ schedule.category }}</span>
                                {% if not schedule.is_confirmed %}<span class="badge small draft">ê¸°íšë¯¸í™•ì •</span>{% endif
                                %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                    {% if not schedules %}
                    <div class="schedule-picker-empty">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    {% endif %}
                </div>
                <input type="hidden" id="formSchedule" name="schedule_id" value="">
            </div>

            <div class="sheet-actions">
                <button type="button" class="btn secondary" onclick="closeSheet()">ì·¨ì†Œ</button>
                <button type="submit" class="btn primary" id="submitBtn">ì¶”ê°€</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* FAB ë²„íŠ¼ */
    .fab {
        position: fixed;
        bottom: 80px;
        /* í•˜ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ìœ„ */
        right: 24px;
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: var(--primary);
        color: white;
        border: none;
        font-size: 28px;
        font-weight: 300;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s;
        z-index: 50;
    }

    .fab:active {
        transform: scale(0.95);
    }

    /* ë°”í…€ì‹œíŠ¸ */
    .sheet {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        display: none;
    }

    .sheet.open {
        display: block;
    }

    .sheet-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        animation: fadeIn 0.2s ease;
    }

    .sheet-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 0 auto;
        max-width: 500px;
        background: var(--bg);
        border-radius: 20px 20px 0 0;
        padding: 12px 20px 32px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
    }

    .sheet-handle {
        width: 36px;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        margin: 0 auto 20px;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(100%);
        }

        to {
            transform: translateY(0);
        }
    }

    /* ë©”ì¸ ì¸í’‹ */
    .sheet-input-main input {
        width: 100%;
        border: none;
        font-size: 18px;
        padding: 12px 0;
        outline: none;
        background: transparent;
    }

    .sheet-input-main input::placeholder {
        color: var(--text-3);
    }

    /* ì˜µì…˜ ë²„íŠ¼ë“¤ */
    .sheet-options {
        display: flex;
        gap: 8px;
        padding: 12px 0;
        border-top: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        margin: 12px 0;
        flex-wrap: wrap;
    }

    .sheet-option {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 20px;
        background: var(--bg);
        font-size: 13px;
        color: var(--text-2);
        cursor: pointer;
        transition: all 0.15s;
    }

    .sheet-option:hover,
    .sheet-option.active {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(37, 99, 235, 0.05);
    }

    .sheet-option-icon {
        font-size: 14px;
    }

    /* ì˜µì…˜ íŒ¨ë„ */
    .sheet-panel {
        padding: 12px 0;
        animation: fadeIn 0.2s ease;
    }

    .sheet-panel select,
    .sheet-panel input {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 15px;
        background: var(--bg);
    }

    /* ìº˜ë¦°ë” */
    .date-picker {
        background: var(--bg);
    }

    .date-picker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        font-weight: 600;
    }

    .date-picker-header button {
        width: 36px;
        height: 36px;
        border: none;
        background: var(--bg-2);
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
    }

    .date-picker-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-size: 12px;
        color: var(--text-3);
        padding: 8px 0;
    }

    .date-picker-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }

    .date-picker-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 14px;
        cursor: pointer;
        border: none;
        background: transparent;
    }

    .date-picker-day:hover {
        background: var(--bg-2);
    }

    .date-picker-day.today {
        border: 2px solid var(--primary);
    }

    .date-picker-day.selected {
        background: var(--primary);
        color: white;
    }

    .date-picker-day.other-month {
        color: var(--text-3);
    }

    .quick-dates {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
    }

    .quick-dates button {
        flex: 1;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg-2);
        font-size: 13px;
        cursor: pointer;
    }

    .quick-dates button:hover {
        background: var(--border);
    }

    /* ì¼ì • ì„ íƒ */
    .schedule-picker {
        max-height: 350px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .schedule-picker-month {
        padding: 10px 14px 6px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-3);
        background: var(--bg-2);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .schedule-picker-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 14px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.15s;
        min-height: 60px;
    }

    .schedule-picker-item:active {
        background: var(--bg-2);
    }

    .schedule-picker-item.selected {
        background: rgba(37, 99, 235, 0.12);
        border: 2px solid var(--primary);
    }

    .schedule-picker-item.none {
        border-bottom: 1px solid var(--border);
        margin-bottom: 6px;
        border-radius: 0;
        min-height: 48px;
    }

    .schedule-picker-icon {
        font-size: 20px;
        color: var(--text-3);
    }

    .schedule-picker-date {
        width: 48px;
        text-align: center;
        flex-shrink: 0;
        background: var(--bg-2);
        padding: 8px 4px;
        border-radius: 8px;
    }

    .schedule-picker-date .day {
        display: block;
        font-size: 20px;
        font-weight: 600;
        color: var(--text);
        line-height: 1.2;
    }

    .schedule-picker-date .weekday {
        display: block;
        font-size: 11px;
        color: var(--text-3);
        margin-top: 2px;
    }

    .schedule-picker-info {
        flex: 1;
        min-width: 0;
    }

    .schedule-picker-title {
        font-size: 15px;
        font-weight: 500;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .schedule-picker-meta {
        display: flex;
        gap: 6px;
        margin-top: 4px;
    }

    .badge.small {
        font-size: 11px;
        padding: 3px 8px;
    }

    .schedule-picker-empty {
        padding: 32px 20px;
        text-align: center;
        color: var(--text-3);
        font-size: 14px;
    }

    /* ì•¡ì…˜ ë²„íŠ¼ */
    .sheet-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .sheet-actions .btn {
        flex: 1;
        padding: 14px;
        font-size: 16px;
    }

    /* task-info í´ë¦­ ê°€ëŠ¥ */
    .task-info {
        cursor: pointer;
    }

    /* task ì„¸ë¶€ ì •ë³´ */
    .task-details {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }

    /* ì—°ê²°ëœ ì¼ì • í‘œì‹œ */
    .task-schedule {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        padding: 10px 12px;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 10px;
        text-decoration: none;
        transition: background 0.15s;
    }

    .task-schedule:active {
        background: #e0f2fe;
    }

    .task-schedule-icon {
        font-size: 20px;
    }

    .task-schedule-info {
        flex: 1;
        min-width: 0;
    }

    .task-schedule-title {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .task-schedule-date {
        display: block;
        font-size: 12px;
        color: var(--primary);
        margin-top: 2px;
    }

    /* ì‚­ì œ ë²„íŠ¼ */
    .btn-icon.delete {
        color: var(--text-3);
        font-size: 20px;
    }

    .btn-icon.delete:hover {
        color: var(--danger);
        background: rgba(220, 38, 38, 0.1);
    }

    .assignee.mine {
        background: #dbeafe;
        color: var(--primary);
        font-weight: 500;
    }
</style>

<script>
    let editMode = false;
    let editTaskId = null;
    let calendarDate = new Date();
    let selectedDate = null;
    let selectedScheduleId = '';

    function openAdd() {
        editMode = false;
        editTaskId = null;
        document.getElementById('taskForm').action = '{{ url_for("task_add") }}';
        document.getElementById('formContent').value = '';
        document.getElementById('formActivist').value = '';
        document.getElementById('formDeadline').value = '';
        document.getElementById('formSchedule').value = '';
        selectedDate = null;
        selectedScheduleId = '';
        document.getElementById('submitBtn').textContent = 'ì¶”ê°€';
        updateAllLabels();
        closeAllPanels();
        renderCalendar();
        document.getElementById('sheet').classList.add('open');
        document.getElementById('formContent').focus();
    }

    function openEdit(id, content, activist, deadline, scheduleId) {
        editMode = true;
        editTaskId = id;
        document.getElementById('taskForm').action = `/task/${id}/edit`;
        document.getElementById('formContent').value = content;
        document.getElementById('formActivist').value = activist || '';
        document.getElementById('formDeadline').value = deadline || '';
        document.getElementById('formSchedule').value = scheduleId || '';
        selectedDate = deadline ? new Date(deadline) : null;
        selectedScheduleId = scheduleId || '';
        if (selectedDate) calendarDate = new Date(selectedDate);
        document.getElementById('submitBtn').textContent = 'ì €ì¥';
        updateAllLabels();
        closeAllPanels();
        renderCalendar();
        document.getElementById('sheet').classList.add('open');
        document.getElementById('formContent').focus();
    }

    function closeSheet() {
        document.getElementById('sheet').classList.remove('open');
    }

    function toggleOption(type) {
        const panels = ['Assignee', 'Deadline', 'Schedule'];
        panels.forEach(p => {
            const panel = document.getElementById('option' + p);
            if (p.toLowerCase() === type) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                if (p === 'Deadline' && panel.style.display === 'block') renderCalendar();
            } else {
                panel.style.display = 'none';
            }
        });
    }

    function closeAllPanels() {
        document.getElementById('optionAssignee').style.display = 'none';
        document.getElementById('optionDeadline').style.display = 'none';
        document.getElementById('optionSchedule').style.display = 'none';
    }

    function updateAssigneeLabel() {
        const select = document.getElementById('formActivist');
        const label = document.getElementById('assigneeLabel');
        label.textContent = select.value ? select.options[select.selectedIndex].text : 'ë‹´ë‹¹ì';
    }

    function updateDeadlineLabel() {
        const label = document.getElementById('deadlineLabel');
        if (selectedDate) {
            label.textContent = `${selectedDate.getMonth() + 1}/${selectedDate.getDate()}`;
        } else {
            label.textContent = 'ë§ˆê°ì¼';
        }
    }

    function updateScheduleLabel() {
        const label = document.getElementById('scheduleLabel');
        if (selectedScheduleId) {
            const items = document.querySelectorAll('.schedule-picker-item');
            items.forEach(item => {
                if (item.onclick && item.onclick.toString().includes(selectedScheduleId)) {
                    const title = item.querySelector('.schedule-picker-title');
                    if (title) {
                        const text = title.textContent;
                        label.textContent = text.length > 6 ? text.substring(0, 6) + '..' : text;
                    }
                }
            });
        } else {
            label.textContent = 'ì¼ì •';
        }
    }

    function updateAllLabels() {
        updateAssigneeLabel();
        updateDeadlineLabel();
        updateScheduleLabel();
    }

    // ìº˜ë¦°ë”
    function renderCalendar() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        document.getElementById('calendarMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        let html = '';

        // ì´ì „ ë‹¬ ë‚ ì§œ
        const prevLastDate = new Date(year, month, 0).getDate();
        for (let i = firstDay - 1; i >= 0; i--) {
            html += `<button type="button" class="date-picker-day other-month" onclick="selectDate(${year}, ${month - 1}, ${prevLastDate - i})">${prevLastDate - i}</button>`;
        }

        // í˜„ì¬ ë‹¬ ë‚ ì§œ
        for (let d = 1; d <= lastDate; d++) {
            const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
            const isSelected = selectedDate && selectedDate.getFullYear() === year && selectedDate.getMonth() === month && selectedDate.getDate() === d;
            const classes = ['date-picker-day'];
            if (isToday) classes.push('today');
            if (isSelected) classes.push('selected');
            html += `<button type="button" class="${classes.join(' ')}" onclick="selectDate(${year}, ${month}, ${d})">${d}</button>`;
        }

        // ë‹¤ìŒ ë‹¬ ë‚ ì§œ (6ì£¼ ì±„ìš°ê¸°)
        const totalCells = firstDay + lastDate;
        const remaining = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
        for (let d = 1; d <= remaining; d++) {
            html += `<button type="button" class="date-picker-day other-month" onclick="selectDate(${year}, ${month + 1}, ${d})">${d}</button>`;
        }

        document.getElementById('calendarDays').innerHTML = html;
    }

    function changeMonth(delta) {
        calendarDate.setMonth(calendarDate.getMonth() + delta);
        renderCalendar();
    }

    function selectDate(year, month, day) {
        selectedDate = new Date(year, month, day);
        calendarDate = new Date(selectedDate);
        const yyyy = selectedDate.getFullYear();
        const mm = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const dd = String(selectedDate.getDate()).padStart(2, '0');
        document.getElementById('formDeadline').value = `${yyyy}-${mm}-${dd}`;
        updateDeadlineLabel();
        renderCalendar();
    }

    function setQuickDate(days) {
        const date = new Date();
        date.setDate(date.getDate() + days);
        selectDate(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function clearDate() {
        selectedDate = null;
        document.getElementById('formDeadline').value = '';
        updateDeadlineLabel();
        renderCalendar();
    }

    // ì¼ì • ì„ íƒ
    function selectSchedule(id, title) {
        selectedScheduleId = id;
        document.getElementById('formSchedule').value = id;
        document.querySelectorAll('.schedule-picker-item').forEach(item => item.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        updateScheduleLabel();
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeSheet();
    });

    // ì´ˆê¸°í™”
    renderCalendar();
</script>
{% endblock %}