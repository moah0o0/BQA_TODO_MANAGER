{% extends "base.html" %}

{% block title %}ì¼ì • - ë¶€ì‚°í€´ì–´í–‰ë™{% endblock %}

{% block content %}
<!-- í—¤ë” -->
<div class="schedule-header">
    <!-- ì›”ë³„ ë¹ ë¥¸ ì´ë™ -->
    <div class="month-nav" id="monthNav">
        <div class="month-nav-inner">
            {% for month in grouped_schedules.keys() %}
            <button type="button" class="month-nav-item" data-month="{{ month }}" onclick="scrollToMonth('{{ month }}')">{{ month }}</button>
            {% endfor %}
        </div>
        <a href="{{ url_for('schedule_add') }}" class="btn-add">+</a>
    </div>
</div>

<!-- ì½˜í…ì¸  -->
<div class="schedule-page-content">

<!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
<div class="filter-bar category-bar">
    <div class="category-chips">
        <button type="button" class="category-chip" data-category="ì •ê¸°ëª¨ì„" onclick="toggleCategory('ì •ê¸°ëª¨ì„')">ì •ê¸°ëª¨ì„</button>
        <button type="button" class="category-chip" data-category="ì •ê¸°ëª¨ì„ ì—°ê³„í™œë™" onclick="toggleCategory('ì •ê¸°ëª¨ì„ ì—°ê³„í™œë™')">ì—°ê³„</button>
        <button type="button" class="category-chip" data-category="ì—°ëŒ€ì‚¬ì—…" onclick="toggleCategory('ì—°ëŒ€ì‚¬ì—…')">ì—°ëŒ€</button>
        <button type="button" class="category-chip" data-category="ì˜ê²°ê¸°ê´€" onclick="toggleCategory('ì˜ê²°ê¸°ê´€')">ì˜ê²°</button>
    </div>
</div>

<!-- ì—°ì¤‘ ì¼ì • (ìŠ¬ë¼ì´ë“œ) -->
{% if yearly_schedules %}
<section class="section yearly-section">
    <h2 class="section-title">ğŸ”„ ì—°ì¤‘</h2>
    <p class="help-text">íŠ¹ì • ë‚ ì§œ ì—†ì´ ì—°ì¤‘ ì§„í–‰ë˜ëŠ” ì‚¬ì—…ì´ì—ìš”.</p>
    <div class="yearly-slider">
        {% for schedule in yearly_schedules %}
        <a href="{{ url_for('schedule_detail', schedule_id=schedule.id) }}" class="yearly-card" data-category="{{ schedule.category }}">
            <div class="yearly-title">{{ schedule.title }}</div>
            <div class="yearly-meta">
                <span class="badge small category">{{ schedule.category }}</span>
                {% if schedule.idea_count %}<span class="idea-badge">ğŸ’¡ {{ schedule.idea_count }}</span>{% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- ì›”ë³„ ì¼ì • -->
{% for month, schedules in grouped_schedules.items() %}
<section class="section" id="month-{{ loop.index }}" data-month="{{ month }}">
    <h2 class="section-title">{{ month }}</h2>
    <div class="schedule-list">
        {% for schedule in schedules %}
        <a href="{{ url_for('schedule_detail', schedule_id=schedule.id) }}" class="schedule-card {% if schedule.is_completed %}done{% endif %}{% if schedule.needs_advance_prep %} prep{% endif %}" data-category="{{ schedule.category }}">
            {% if schedule.needs_advance_prep %}<div class="prep-label">ì‚¬ì „ì¤€ë¹„ í•„ìš”</div>{% endif %}
            <div class="schedule-title">{{ schedule.title }}</div>
            <div class="schedule-meta">
                <span>{{ schedule.date | date_kr }}</span>
                {% if schedule.start_time %}
                <span>{{ schedule.start_time }}{% if schedule.end_time %}-{{ schedule.end_time }}{% endif %}</span>
                {% endif %}
                {% if schedule.location %}
                <span>ğŸ“ {{ schedule.location }}</span>
                {% endif %}
                <span class="badge category">{{ schedule.category }}</span>
                {% if not schedule.is_confirmed %}<span class="badge draft">ë¯¸í™•ì •</span>{% endif %}
            </div>
            {% if schedule.details %}
            <div class="schedule-preview">{{ schedule.details | strip_html }}</div>
            {% endif %}
            {% if schedule.task_count or schedule.idea_count %}
            <div class="schedule-counts">
                {% if schedule.task_count %}
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ (schedule.completed_count / schedule.task_count * 100) | int if schedule.task_count > 0 else 0 }}%"></div>
                </div>
                <span class="progress-text">{{ schedule.completed_count|int }}/{{ schedule.task_count }} TODO</span>
                {% endif %}
                {% if schedule.idea_count %}
                <span class="idea-count">ğŸ’¡ {{ schedule.idea_count }}</span>
                {% endif %}
            </div>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</section>
{% else %}
<div class="empty">
    <p>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>
    <a href="{{ url_for('schedule_add') }}" class="btn primary">+ ìƒˆ ì¼ì • ì¶”ê°€</a>
</div>
{% endfor %}

</div><!-- /schedule-page-content -->

<style>
/* ì¼ì • í˜ì´ì§€ í—¤ë” */
.schedule-header {
    position: fixed;
    top: 57px;
    left: 0;
    right: 0;
    z-index: 50;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 0 16px;
}

@media (min-width: 768px) {
    .schedule-header {
        left: 50%;
        transform: translateX(-50%);
        max-width: 600px;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        padding: 0 24px;
    }
}

/* ì›”ë³„ ë¹ ë¥¸ ì´ë™ */
.month-nav {
    display: flex;
    align-items: center;
    gap: 12px;
}

.month-nav-inner {
    flex: 1;
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding: 12px 0;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.month-nav-inner::-webkit-scrollbar {
    display: none;
}

.month-nav-item {
    flex-shrink: 0;
    padding: 6px 12px;
    border: none;
    border-radius: 16px;
    background: var(--bg-2);
    font-size: 13px;
    font-weight: 500;
    color: var(--text-2);
    cursor: pointer;
    transition: all 0.15s;
}

.month-nav-item.active {
    background: var(--primary);
    color: white;
}

.btn-add {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary);
    color: white;
    border-radius: 8px;
    font-size: 20px;
    font-weight: 300;
    text-decoration: none;
    flex-shrink: 0;
}

/* ì½˜í…ì¸  ì˜ì—­ */
.schedule-page-content {
    padding-top: 70px;
}

/* ì¹´í…Œê³ ë¦¬ í•„í„° ë°” */
.category-bar {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 12px;
}

.category-chips {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.category-chip {
    flex-shrink: 0;
    padding: 5px 12px;
    border: 1px solid var(--border);
    border-radius: 14px;
    background: var(--bg);
    font-size: 12px;
    color: var(--text-2);
    cursor: pointer;
    transition: all 0.15s;
}

.category-chip.active {
    background: var(--text);
    border-color: var(--text);
    color: white;
}

/* ê°•ì¡°ëœ ì¼ì • - ë¶€ê° */
.schedule-card.highlighted,
.yearly-card.highlighted {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
}

/* ê°•ì¡°ë˜ì§€ ì•Šì€ ì¼ì • - ì‘ê²Œ í‘œì‹œ */
.schedule-card.dimmed,
.yearly-card.dimmed {
    opacity: 0.5;
    padding: 10px 12px;
}

.schedule-card.dimmed .schedule-title {
    font-size: 13px;
}

.schedule-card.dimmed .schedule-meta {
    font-size: 11px;
}

.schedule-card.dimmed .schedule-preview,
.schedule-card.dimmed .schedule-counts,
.schedule-card.dimmed .prep-label {
    display: none;
}

.yearly-card.dimmed {
    padding: 8px 12px;
}

.yearly-card.dimmed .yearly-title {
    font-size: 12px;
}

/* ì‚¬ì „ì¤€ë¹„ í•„ìš” ì¼ì • */
.schedule-card.prep {
    border-left: 3px solid #f59e0b;
}

.prep-label {
    font-size: 11px;
    color: #d97706;
    font-weight: 500;
    margin-bottom: 4px;
}

/* TODO/ì•„ì´ë””ì–´ ì¹´ìš´íŠ¸ */
.schedule-counts {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 10px;
}

.schedule-counts .progress-bar {
    flex: 1;
    margin-top: 0;
}

.schedule-counts .progress-text {
    margin-top: 0;
    flex-shrink: 0;
}

.idea-count {
    font-size: 12px;
    color: var(--text-2);
    flex-shrink: 0;
}
</style>

<script>
// ì¹´í…Œê³ ë¦¬ í•„í„° ê¸°ëŠ¥
const CATEGORY_KEY = 'highlighted_categories';

function getHighlightedCategories() {
    const saved = localStorage.getItem(CATEGORY_KEY);
    return saved ? JSON.parse(saved) : [];
}

function saveHighlightedCategories(categories) {
    localStorage.setItem(CATEGORY_KEY, JSON.stringify(categories));
}

function toggleCategory(category) {
    let categories = getHighlightedCategories();
    const index = categories.indexOf(category);

    if (index === -1) {
        categories.push(category);
    } else {
        categories.splice(index, 1);
    }

    saveHighlightedCategories(categories);
    applyHighlight();
}

function applyHighlight() {
    const categories = getHighlightedCategories();

    // ì¹© ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.category-chip').forEach(chip => {
        const cat = chip.dataset.category;
        chip.classList.toggle('active', categories.includes(cat));
    });

    // ì¼ì • ì¹´ë“œ dimmed/highlighted ìƒíƒœ ì ìš©
    const cards = document.querySelectorAll('.schedule-card, .yearly-card');
    cards.forEach(card => {
        const cardCategory = card.dataset.category;
        if (categories.length === 0) {
            // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ëª¨ë‘ ì •ìƒ í‘œì‹œ
            card.classList.remove('dimmed', 'highlighted');
        } else if (categories.includes(cardCategory)) {
            // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ì— í•´ë‹¹í•˜ë©´ ê°•ì¡°
            card.classList.remove('dimmed');
            card.classList.add('highlighted');
        } else {
            // ì„ íƒë˜ì§€ ì•Šì€ ì¹´í…Œê³ ë¦¬ëŠ” íë¦¬ê²Œ
            card.classList.add('dimmed');
            card.classList.remove('highlighted');
        }
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì ìš©
document.addEventListener('DOMContentLoaded', applyHighlight);

// ì›”ë³„ ë¹ ë¥¸ ì´ë™
function scrollToMonth(month) {
    const section = document.querySelector(`section[data-month="${month}"]`);
    if (section) {
        const headerHeight = 57; // ìƒë‹¨ í—¤ë”
        const navHeight = document.querySelector('.month-nav')?.offsetHeight || 0;
        const y = section.getBoundingClientRect().top + window.scrollY - headerHeight - navHeight - 10;
        window.scrollTo({ top: y, behavior: 'smooth' });
    }
}

// ìŠ¤í¬ë¡¤ ì‹œ í˜„ì¬ ì›” í•˜ì´ë¼ì´íŠ¸
function updateActiveMonth() {
    const sections = document.querySelectorAll('section[data-month]');
    const headerHeight = 57;
    const navHeight = document.querySelector('.month-nav')?.offsetHeight || 0;
    const offset = headerHeight + navHeight + 50;
    let currentMonth = null;

    sections.forEach(section => {
        const rect = section.getBoundingClientRect();
        if (rect.top <= offset) {
            currentMonth = section.dataset.month;
        }
    });

    document.querySelectorAll('.month-nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.month === currentMonth);
    });

    // í™œì„±í™”ëœ ë²„íŠ¼ì´ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
    const activeBtn = document.querySelector('.month-nav-item.active');
    if (activeBtn) {
        activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }
}

// ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ (throttle ì ìš©)
let scrollTimeout;
window.addEventListener('scroll', () => {
    if (scrollTimeout) return;
    scrollTimeout = setTimeout(() => {
        updateActiveMonth();
        scrollTimeout = null;
    }, 100);
});

// ì´ˆê¸° ì‹¤í–‰
document.addEventListener('DOMContentLoaded', updateActiveMonth);
</script>
{% endblock %}
