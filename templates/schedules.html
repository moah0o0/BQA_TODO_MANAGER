{% extends "base.html" %}

{% block title %}ì¼ì • - ë¶€ì‚°í€´ì–´í–‰ë™ TODO{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ì¼ì •</h1>
    <p class="page-subtitle">ë¶€ì‚°í€´ì–´í–‰ë™ì˜ ëª¨ë“  ì¼ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
    <div class="header-actions">
        <a href="{{ url_for('schedule_add') }}" class="btn btn-primary">+ ìƒˆ ì¼ì •</a>
    </div>
</div>

<!-- íƒ­ í•„í„° ì„¤ëª… -->
<div class="tabs-with-hint">
    <div class="tabs">
        <a href="{{ url_for('schedules', status='upcoming') }}"
           class="tab {% if current_status == 'upcoming' %}active{% endif %}" title="ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€ ì¼ì •">ì˜ˆì •</a>
        <a href="{{ url_for('schedules', status='completed') }}"
           class="tab {% if current_status == 'completed' %}active{% endif %}" title="ì´ë¯¸ ì™„ë£Œëœ ì¼ì •">ì™„ë£Œ</a>
        <a href="{{ url_for('schedules', status='all') }}"
           class="tab {% if current_status == 'all' %}active{% endif %}" title="ëª¨ë“  ì¼ì • ë³´ê¸°">ì „ì²´</a>
    </div>
    <span class="tabs-hint">
        {% if current_status == 'upcoming' %}ì§„í–‰ ì˜ˆì •ì¸ ì¼ì •ë§Œ í‘œì‹œí•©ë‹ˆë‹¤
        {% elif current_status == 'completed' %}ì™„ë£Œëœ ì¼ì •ë§Œ í‘œì‹œí•©ë‹ˆë‹¤
        {% else %}ëª¨ë“  ì¼ì •ì„ í‘œì‹œí•©ë‹ˆë‹¤{% endif %}
    </span>
</div>

<!-- ì‚¬ì—…ì¢…ë¥˜ í•„í„° -->
<div class="category-filter">
    <span class="category-filter-label">ì‚¬ì—…ì¢…ë¥˜:</span>
    <div class="category-chips">
        <label class="category-chip" data-category="ì •ê¸°ëª¨ì„">
            <input type="checkbox" checked onchange="toggleCategory('ì •ê¸°ëª¨ì„', this.checked)">
            <span>ì •ê¸°ëª¨ì„</span>
        </label>
        <label class="category-chip" data-category="ì •ê¸°ëª¨ì„ ì—°ê³„í™œë™">
            <input type="checkbox" checked onchange="toggleCategory('ì •ê¸°ëª¨ì„ ì—°ê³„í™œë™', this.checked)">
            <span>ì •ê¸°ëª¨ì„ ì—°ê³„í™œë™</span>
        </label>
        <label class="category-chip" data-category="ì˜ê²°ê¸°ê´€">
            <input type="checkbox" checked onchange="toggleCategory('ì˜ê²°ê¸°ê´€', this.checked)">
            <span>ì˜ê²°ê¸°ê´€</span>
        </label>
        <label class="category-chip" data-category="ì—°ëŒ€ì‚¬ì—…">
            <input type="checkbox" onchange="toggleCategory('ì—°ëŒ€ì‚¬ì—…', this.checked)">
            <span>ì—°ëŒ€ì‚¬ì—…</span>
        </label>
    </div>
    {% if yearly_schedules %}
    <button type="button" class="btn btn-ghost btn-sm yearly-btn" onclick="openYearlyModal()" title="ì—°ì¤‘ 1íšŒ ì§„í–‰í•˜ëŠ” ì¼ì • ë³´ê¸°">
        ğŸ“… ì—°ì¤‘ ì¼ì • ({{ yearly_schedules|length }})
    </button>
    {% endif %}
</div>

{% if grouped_schedules %}
{% for month, schedules in grouped_schedules.items() %}
<div class="month-group">
    <div class="month-header">{{ month }}</div>
    <div class="schedule-list">
        {% for schedule in schedules %}
        <div class="schedule-card {% if schedule.is_completed %}completed{% endif %}" data-category="{{ schedule.category }}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <a href="{{ url_for('schedule_detail', schedule_id=schedule.id) }}" style="flex: 1;" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸° ë° ì‹¤ë¬´ ê´€ë¦¬">
                    <div class="schedule-card-title">{{ schedule.title }}</div>
                    <div class="schedule-card-meta">
                        <span>{{ schedule.date | date_kr }}</span>
                        <span class="badge badge-category">{{ schedule.category }}</span>
                        {% if schedule.is_confirmed %}
                        <span class="badge badge-confirmed" title="ê¸°íšì´ í™•ì •ëœ ì¼ì •">í™•ì •</span>
                        {% else %}
                        <span class="badge badge-pending" title="ê¸°íš í™•ì •ì´ í•„ìš”í•œ ì¼ì •">ë¯¸í™•ì •</span>
                        {% endif %}
                    </div>
                </a>
                <div style="display: flex; gap: 4px;">
                    <form action="{{ url_for('schedule_toggle_complete', schedule_id=schedule.id) }}" method="post" class="inline-form">
                        <button type="submit" class="btn btn-ghost btn-sm" title="{% if schedule.is_completed %}ì˜ˆì • ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°{% else %}ì¼ì •ì„ ì™„ë£Œ ì²˜ë¦¬{% endif %}">
                            {% if schedule.is_completed %}ì˜ˆì •ìœ¼ë¡œ{% else %}ì™„ë£Œ{% endif %}
                        </button>
                    </form>
                    <form action="{{ url_for('schedule_delete', schedule_id=schedule.id) }}" method="post" class="inline-form"
                          onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì—°ê²°ëœ ëª¨ë“  ì‹¤ë¬´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.');">
                        <button type="submit" class="btn btn-danger btn-sm" title="ì¼ì •ê³¼ ì—°ê²°ëœ ì‹¤ë¬´ ëª¨ë‘ ì‚­ì œ">ì‚­ì œ</button>
                    </form>
                </div>
            </div>
            {% if schedule.task_count > 0 %}
            <div class="progress-bar" title="ì‹¤ë¬´ ì§„í–‰ë¥ : {{ schedule.completed_count | int }}/{{ schedule.task_count }}">
                <div class="progress-fill" style="width: {{ (schedule.completed_count / schedule.task_count * 100) | int if schedule.task_count > 0 else 0 }}%"></div>
            </div>
            <div class="progress-text">{{ schedule.completed_count | int }}/{{ schedule.task_count }} ì‹¤ë¬´ ì™„ë£Œ</div>
            {% else %}
            <div class="progress-text text-muted">ë“±ë¡ëœ ì‹¤ë¬´ ì—†ìŒ</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}
{% else %}
<div class="empty-state">
    <div class="empty-icon">ğŸ“…</div>
    <div class="empty-message">
        {% if current_status == 'upcoming' %}ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤
        {% elif current_status == 'completed' %}ì™„ë£Œëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤
        {% else %}ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤{% endif %}
    </div>
    <div class="empty-hint">
        {% if current_status == 'upcoming' %}
        <a href="{{ url_for('schedule_add') }}" class="btn btn-primary btn-sm">+ ìƒˆ ì¼ì • ì¶”ê°€</a>
        {% elif current_status == 'completed' %}
        ì¼ì •ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
        {% else %}
        <a href="{{ url_for('schedule_add') }}" class="btn btn-primary btn-sm">+ ìƒˆ ì¼ì • ì¶”ê°€</a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- í•˜ë‹¨ ì•ˆë‚´ -->
<div class="page-footer-hint">
    <div class="hint-item">
        <span class="badge badge-confirmed">í™•ì •</span> ê¸°íšì´ í™•ì •ëœ ì¼ì •
    </div>
    <div class="hint-item">
        <span class="badge badge-pending">ë¯¸í™•ì •</span> ì•„ì§ ì„¸ë¶€ ê¸°íšì´ í•„ìš”í•œ ì¼ì •
    </div>
    <div class="hint-item">
        <strong>ì§„í–‰ë¥  ë°”</strong>: ì—°ê²°ëœ ì‹¤ë¬´ ì™„ë£Œ í˜„í™©
    </div>
</div>

<!-- ì—°ì¤‘ ì¼ì • ëª¨ë‹¬ -->
{% if yearly_schedules %}
<div id="yearly-modal" class="modal-overlay" onclick="closeYearlyOnOverlay(event)">
    <div class="modal modal-lg">
        <div class="modal-header">
            <span class="modal-title">ğŸ“… ì—°ì¤‘ 1íšŒ ì¼ì •</span>
            <button class="modal-close" onclick="closeYearlyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p class="modal-hint">ì—°ì¤‘ ì–´ëŠ ì‹œì ì—ë“  1íšŒ ì§„í–‰í•˜ëŠ” ì¼ì •ì…ë‹ˆë‹¤. ì ì ˆí•œ ì‹œê¸°ì— ê¸°íší•´ì£¼ì„¸ìš”.</p>
            <div class="yearly-list">
                {% for schedule in yearly_schedules %}
                <a href="{{ url_for('schedule_detail', schedule_id=schedule.id) }}" class="yearly-item">
                    <div class="yearly-item-title">{{ schedule.title }}</div>
                    <div class="yearly-item-meta">
                        <span class="badge badge-category">{{ schedule.category }}</span>
                        {% if schedule.is_confirmed %}
                        <span class="badge badge-confirmed">í™•ì •</span>
                        {% else %}
                        <span class="badge badge-pending">ë¯¸í™•ì •</span>
                        {% endif %}
                        {% if schedule.task_count > 0 %}
                        <span class="task-count">ì‹¤ë¬´ {{ schedule.task_count }}ê±´</span>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" onclick="closeYearlyModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>
{% endif %}

<script>
// ì—°ì¤‘ ì¼ì • ëª¨ë‹¬
function openYearlyModal() {
    document.getElementById('yearly-modal').classList.add('active');
}

function closeYearlyModal() {
    document.getElementById('yearly-modal').classList.remove('active');
}

function closeYearlyOnOverlay(event) {
    if (event.target.classList.contains('modal-overlay')) {
        closeYearlyModal();
    }
}

// ì‚¬ì—…ì¢…ë¥˜ í•„í„° ìƒíƒœ (localStorageì— ì €ì¥)
const defaultCategories = ['ì •ê¸°ëª¨ì„', 'ì •ê¸°ëª¨ì„ ì—°ê³„í™œë™', 'ì˜ê²°ê¸°ê´€'];
let selectedCategories = JSON.parse(localStorage.getItem('selectedCategories')) || defaultCategories;

// í˜ì´ì§€ ë¡œë“œ ì‹œ í•„í„° ìƒíƒœ ë³µì›
document.addEventListener('DOMContentLoaded', function() {
    // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
    document.querySelectorAll('.category-chip input').forEach(checkbox => {
        const category = checkbox.closest('.category-chip').dataset.category;
        checkbox.checked = selectedCategories.includes(category);
    });
    // í•„í„° ì ìš©
    applyFilter();
});

function toggleCategory(category, checked) {
    if (checked) {
        if (!selectedCategories.includes(category)) {
            selectedCategories.push(category);
        }
    } else {
        selectedCategories = selectedCategories.filter(c => c !== category);
    }
    localStorage.setItem('selectedCategories', JSON.stringify(selectedCategories));
    applyFilter();
}

function applyFilter() {
    document.querySelectorAll('.schedule-card').forEach(card => {
        const category = card.dataset.category;
        if (selectedCategories.includes(category)) {
            card.classList.remove('collapsed');
        } else {
            card.classList.add('collapsed');
        }
    });

    // ì›”ë³„ ê·¸ë£¹ ë‚´ ëª¨ë“  ì¹´ë“œê°€ collapsedë©´ ê·¸ë£¹ë„ ì¶•ì†Œ í‘œì‹œ
    document.querySelectorAll('.month-group').forEach(group => {
        const cards = group.querySelectorAll('.schedule-card');
        const visibleCards = group.querySelectorAll('.schedule-card:not(.collapsed)');
        if (visibleCards.length === 0 && cards.length > 0) {
            group.classList.add('all-collapsed');
        } else {
            group.classList.remove('all-collapsed');
        }
    });
}
</script>
{% endblock %}
