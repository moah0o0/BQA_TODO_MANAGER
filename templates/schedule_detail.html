{% extends "base.html" %}

{% block title %}{{ schedule.title }} - ë¶€ì‚°í€´ì–´í–‰ë™{% endblock %}

{% block content %}
<!-- í—¤ë” -->
<div class="detail-header">
    <a href="{{ url_for('schedules') }}" class="detail-back">â† ì¼ì • ëª©ë¡</a>
    <h1 class="detail-title">{{ schedule.title }}</h1>
    <div class="detail-meta">
        <span>{{ schedule.date | date_kr }}</span>
        {% if schedule.start_time or schedule.end_time %}
        <span>{{ schedule.start_time or '' }}{% if schedule.start_time and schedule.end_time %} - {% endif %}{{ schedule.end_time or '' }}</span>
        {% endif %}
        {% if schedule.location %}
        <span>ğŸ“ {{ schedule.location }}</span>
        {% endif %}
        <span class="badge category">{{ schedule.category }}</span>
        {% if not schedule.is_confirmed %}
        <span class="badge draft">ê¸°íšë¯¸í™•ì •</span>
        {% endif %}
    </div>
    <div class="detail-actions">
        <a href="{{ url_for('schedule_edit', schedule_id=schedule.id) }}" class="btn secondary">ìˆ˜ì •</a>
        <form action="{{ url_for('schedule_toggle_complete', schedule_id=schedule.id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn {% if schedule.is_completed %}secondary{% else %}primary{% endif %}">
                {% if schedule.is_completed %}ì˜ˆì •ìœ¼ë¡œ{% else %}ì™„ë£Œ ì²˜ë¦¬{% endif %}
            </button>
        </form>
        <form action="{{ url_for('schedule_delete', schedule_id=schedule.id) }}" method="post" style="display:inline;" onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            <button type="submit" class="btn danger">ì‚­ì œ</button>
        </form>
    </div>
</div>

<!-- ì§„í–‰ë¥  -->
{% if total_tasks > 0 %}
<div class="detail-progress">
    <div class="detail-progress-row">
        <span>TODO ì§„í–‰ë¥ </span>
        <span>{{ completed_tasks }}/{{ total_tasks }} ({{ progress }}%)</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ progress }}%"></div>
    </div>
</div>
{% endif %}

<!-- ì„¸ë¶€ë‚´ìš© -->
{% if schedule.details %}
<section class="section">
    <h2 class="section-title">ğŸ“‹ ì„¸ë¶€ë‚´ìš©</h2>
    <div class="content-box">{{ schedule.details | safe }}</div>
</section>
{% endif %}

<!-- ì•„ì´ë””ì–´ -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">ğŸ’¡ ì•„ì´ë””ì–´ {% if idea_tasks %}({{ idea_tasks|length }}){% endif %}</h2>
        <button type="button" class="btn-add" onclick="openIdeaAdd()">+ ì¶”ê°€</button>
    </div>
    <p class="help-text">ê¸°íš ë‹¨ê³„ì˜ ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ì˜¬ë ¤ë³´ì„¸ìš”. í´ë¦­í•˜ë©´ ìˆ˜ì •, ìì„¸íˆ ë³´ê¸°ë¡œ ìƒì„¸ ë‚´ìš© í™•ì¸ ê°€ëŠ¥.</p>
    {% if idea_tasks %}
    <div class="idea-list">
        {% for task in idea_tasks %}
        <div class="idea-card {% if task.is_completed %}done{% endif %}" data-id="{{ task.id }}">
            <div class="idea-header">
                <button type="button" class="checkbox" onclick="toggleTask({{ task.id }}, this)">{% if task.is_completed %}âœ“{% endif %}</button>
                <div class="idea-main" onclick="openIdeaEdit({{ task.id }}, `{{ task.content | replace('`', '\\`') }}`, '{{ task.activist_id or '' }}', `{{ task.details | replace('`', '\\`') if task.details else '' }}`)">
                    <div class="idea-title">{{ task.content }}</div>
                    {% if task.details %}
                    <div class="idea-preview">{{ task.details | strip_html | truncate(50) }}</div>
                    {% endif %}
                    <div class="idea-meta">
                        <span class="assignee">{{ task.activist_name or 'ìµëª…' }}</span>
                    </div>
                </div>
                <form action="{{ url_for('task_delete', task_id=task.id) }}" method="post" onsubmit="return confirm('ì‚­ì œ?')">
                    <button type="submit" class="btn-icon delete">Ã—</button>
                </form>
            </div>
            {% if task.details %}
            <div class="idea-details-toggle">
                <button type="button" onclick="toggleIdeaDetails(this)">ìì„¸íˆ ë³´ê¸° â–¼</button>
            </div>
            <div class="idea-details" style="display: none;">
                {{ task.details | safe }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty">
        <p>ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
    </div>
    {% endif %}
</section>

<!-- ê´€ë ¨ TODO -->
<section class="section">
    <h2 class="section-title">ğŸ“ ê´€ë ¨ TODO {% if action_tasks %}({{ action_tasks|length }}){% endif %}</h2>
    <p class="help-text">ì´ ì¼ì •ì— ì—°ê²°ëœ TODOì˜ˆìš”. TODO íƒ­ì—ì„œ ì¼ì •ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.</p>
    {% if action_tasks %}
    <div class="task-list">
        {% for task in action_tasks %}
        <div class="task-row {% if task.is_completed %}done{% endif %}" data-id="{{ task.id }}">
            <button type="button" class="checkbox" onclick="toggleTask({{ task.id }}, this)">{% if task.is_completed %}âœ“{% endif %}</button>
            <div class="task-info">
                <span class="task-text">{{ task.content }}</span>
                <span class="task-meta">
                    {% if task.deadline %}
                    <span class="dday {{ task.deadline | dday_class }}">{{ task.deadline | dday }}</span>
                    {% endif %}
                    {% if task.activist_name %}<span class="assignee">{{ task.activist_name }}</span>{% else %}<span class="assignee unassigned">ë¯¸ì •</span>{% endif %}
                </span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty">
        <p>ê´€ë ¨ TODOê°€ ì—†ìŠµë‹ˆë‹¤</p>
        <p class="hint">TODO íƒ­ì—ì„œ ì´ ì¼ì •ì„ ì—°ê²°í•˜ì„¸ìš”</p>
    </div>
    {% endif %}
</section>

<!-- ì•„ì´ë””ì–´ ë°”í…€ì‹œíŠ¸ -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<div id="ideaSheet" class="sheet">
    <div class="sheet-bg" onclick="closeIdeaSheet()"></div>
    <div class="sheet-content">
        <div class="sheet-handle"></div>
        <form id="ideaForm" action="{{ url_for('task_add') }}" method="post">
            <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
            <input type="hidden" name="referer" value="{{ request.url }}">
            <input type="hidden" name="is_idea" value="1">

            <div class="sheet-input-main">
                <input type="text" id="ideaContent" name="content" placeholder="ì•„ì´ë””ì–´ ì œëª©" required autocomplete="off">
            </div>

            <div class="sheet-options">
                <button type="button" class="sheet-option" onclick="toggleIdeaOption('activist')">
                    <span class="sheet-option-icon">ğŸ‘¤</span>
                    <span id="ideaActivistLabel">ì œì•ˆì</span>
                </button>
                <button type="button" class="sheet-option" onclick="toggleIdeaOption('details')">
                    <span class="sheet-option-icon">ğŸ“</span>
                    <span>ìƒì„¸ë‚´ìš©</span>
                </button>
            </div>

            <div id="ideaActivistPanel" class="sheet-panel" style="display:none;">
                <select id="ideaActivist" name="activist_id" onchange="updateIdeaActivistLabel()">
                    <option value="">ì œì•ˆì ì—†ìŒ</option>
                    {% for activist in activists %}
                    <option value="{{ activist.id }}">{{ activist.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="ideaDetailsPanel" class="sheet-panel" style="display:none;">
                <div id="ideaEditor"></div>
                <input type="hidden" id="ideaDetails" name="details">
            </div>

            <div class="sheet-actions">
                <button type="button" class="btn secondary" onclick="closeIdeaSheet()">ì·¨ì†Œ</button>
                <button type="submit" class="btn primary" id="ideaSubmitBtn">ì¶”ê°€</button>
            </div>
        </form>
    </div>
</div>

<style>
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.section-header .section-title {
    margin-bottom: 0;
}
.btn-add {
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    font-size: 13px;
    color: var(--text-2);
    cursor: pointer;
}
.btn-add:hover {
    background: var(--bg-2);
}
.task-info {
    cursor: pointer;
}
.btn-icon.delete {
    color: var(--text-3);
    font-size: 20px;
}
.btn-icon.delete:hover {
    color: var(--danger);
    background: rgba(220, 38, 38, 0.1);
}

/* ë°”í…€ì‹œíŠ¸ */
.sheet {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: none;
}
.sheet.open {
    display: block;
}
.sheet-bg {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.4);
    animation: fadeIn 0.2s ease;
}
.sheet-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    margin: 0 auto;
    max-width: 500px;
    background: var(--bg);
    border-radius: 20px 20px 0 0;
    padding: 12px 20px 32px;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
}
.sheet-handle {
    width: 36px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 20px;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}
.sheet-input-main input {
    width: 100%;
    border: none;
    font-size: 18px;
    padding: 12px 0;
    outline: none;
    background: transparent;
}
.sheet-input-main input::placeholder {
    color: var(--text-3);
}
.sheet-options {
    display: flex;
    gap: 8px;
    padding: 12px 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    margin: 12px 0;
}
.sheet-option {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 20px;
    background: var(--bg);
    font-size: 13px;
    color: var(--text-2);
    cursor: pointer;
    transition: all 0.15s;
}
.sheet-option:hover, .sheet-option.active {
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(37, 99, 235, 0.05);
}
.sheet-option-icon {
    font-size: 14px;
}
.sheet-panel {
    padding: 12px 0;
    animation: fadeIn 0.2s ease;
}
.sheet-panel select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 15px;
    background: var(--bg);
}
.sheet-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}
.sheet-actions .btn {
    flex: 1;
    padding: 14px;
    font-size: 16px;
}

/* ì•„ì´ë””ì–´ ì¹´ë“œ */
.idea-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.idea-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
}
.idea-card.done {
    background: var(--bg-2);
}
.idea-card.done .idea-title {
    color: var(--text-3);
    text-decoration: line-through;
}
.idea-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}
.idea-main {
    flex: 1;
    min-width: 0;
    cursor: pointer;
}
.idea-title {
    font-size: 15px;
    font-weight: 500;
    line-height: 1.4;
}
.idea-preview {
    font-size: 13px;
    color: var(--text-2);
    margin-top: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.idea-meta {
    display: flex;
    gap: 8px;
    margin-top: 6px;
    font-size: 12px;
}
.idea-details-toggle {
    margin-top: 10px;
    padding-left: 36px;
}
.idea-details-toggle button {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 13px;
    cursor: pointer;
    padding: 0;
}
.idea-details {
    margin-top: 10px;
    padding: 12px;
    background: var(--bg-2);
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
}
.idea-details p {
    margin: 0 0 8px;
}
.idea-details p:last-child {
    margin-bottom: 0;
}

/* Quill ì—ë””í„° (ì•„ì´ë””ì–´ìš©) */
#ideaEditor {
    height: 150px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
}
#ideaEditor .ql-editor {
    font-size: 15px;
}
</style>

<script>
let editMode = false;
let editTaskId = null;
let ideaQuill = null;

// Quill ì—ë””í„° ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    ideaQuill = new Quill('#ideaEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['clean']
            ]
        },
        placeholder: 'ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...'
    });
});

function openIdeaAdd() {
    editMode = false;
    editTaskId = null;
    document.getElementById('ideaForm').action = '{{ url_for("task_add") }}';
    document.getElementById('ideaContent').value = '';
    document.getElementById('ideaActivist').value = '';
    document.getElementById('ideaSubmitBtn').textContent = 'ì¶”ê°€';
    document.getElementById('ideaActivistLabel').textContent = 'ì œì•ˆì';
    document.getElementById('ideaActivistPanel').style.display = 'none';
    document.getElementById('ideaDetailsPanel').style.display = 'none';
    if (ideaQuill) ideaQuill.root.innerHTML = '';
    document.getElementById('ideaSheet').classList.add('open');
    document.getElementById('ideaContent').focus();
}

function openIdeaEdit(id, content, activist, details) {
    editMode = true;
    editTaskId = id;
    document.getElementById('ideaForm').action = `/task/${id}/edit`;
    document.getElementById('ideaContent').value = content;
    document.getElementById('ideaActivist').value = activist || '';
    document.getElementById('ideaSubmitBtn').textContent = 'ì €ì¥';
    updateIdeaActivistLabel();
    document.getElementById('ideaActivistPanel').style.display = 'none';
    document.getElementById('ideaDetailsPanel').style.display = 'none';
    if (ideaQuill) {
        ideaQuill.root.innerHTML = details || '';
    }
    document.getElementById('ideaSheet').classList.add('open');
    document.getElementById('ideaContent').focus();
}

function closeIdeaSheet() {
    document.getElementById('ideaSheet').classList.remove('open');
}

function toggleIdeaOption(type) {
    const activistPanel = document.getElementById('ideaActivistPanel');
    const detailsPanel = document.getElementById('ideaDetailsPanel');

    if (type === 'activist') {
        activistPanel.style.display = activistPanel.style.display === 'none' ? 'block' : 'none';
        detailsPanel.style.display = 'none';
    } else if (type === 'details') {
        detailsPanel.style.display = detailsPanel.style.display === 'none' ? 'block' : 'none';
        activistPanel.style.display = 'none';
    }
}

function updateIdeaActivistLabel() {
    const select = document.getElementById('ideaActivist');
    const label = document.getElementById('ideaActivistLabel');
    label.textContent = select.value ? select.options[select.selectedIndex].text : 'ì œì•ˆì';
}

function toggleIdeaDetails(btn) {
    const card = btn.closest('.idea-card');
    const details = card.querySelector('.idea-details');
    if (details.style.display === 'none') {
        details.style.display = 'block';
        btn.textContent = 'ì ‘ê¸° â–²';
    } else {
        details.style.display = 'none';
        btn.textContent = 'ìì„¸íˆ ë³´ê¸° â–¼';
    }
}

// í¼ ì œì¶œ ì‹œ Quill ë‚´ìš© ì €ì¥
document.getElementById('ideaForm').addEventListener('submit', function() {
    if (ideaQuill) {
        document.getElementById('ideaDetails').value = ideaQuill.root.innerHTML;
    }
});

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeIdeaSheet();
});
</script>
{% endblock %}
