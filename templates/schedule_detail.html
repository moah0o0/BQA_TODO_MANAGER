{% extends "base.html" %}

{% block title %}{{ schedule.title }} - ë¶€ì‚°í€´ì–´í–‰ë™ TODO{% endblock %}

{% block content %}
<!-- í—¤ë” -->
<div class="detail-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <a href="{{ url_for('schedules') }}" class="btn btn-ghost btn-sm" title="ì¼ì • ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°">&larr; ëª©ë¡</a>
        <div style="display: flex; gap: 8px;">
            <a href="{{ url_for('schedule_edit', schedule_id=schedule.id) }}" class="btn btn-secondary btn-sm" title="ì¼ì • ì •ë³´ ìˆ˜ì •">ìˆ˜ì •</a>
            <form action="{{ url_for('schedule_toggle_complete', schedule_id=schedule.id) }}" method="post" class="inline-form">
                <button type="submit" class="btn btn-sm {% if schedule.is_completed %}btn-ghost{% else %}btn-primary{% endif %}" title="{% if schedule.is_completed %}ì˜ˆì • ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°{% else %}ì¼ì •ì„ ì™„ë£Œ ì²˜ë¦¬{% endif %}">
                    {% if schedule.is_completed %}ì˜ˆì •ìœ¼ë¡œ ë³€ê²½{% else %}ì™„ë£Œ ì²˜ë¦¬{% endif %}
                </button>
            </form>
        </div>
    </div>
    <h1 class="detail-title">{{ schedule.title }}</h1>
    <div class="detail-meta">
        <span>{{ schedule.date | date_kr }}</span>
        <span class="badge badge-category">{{ schedule.category }}</span>
        {% if schedule.is_confirmed %}
        <span class="badge badge-confirmed" title="ê¸°íšì´ í™•ì •ëœ ì¼ì •ì…ë‹ˆë‹¤">í™•ì •</span>
        {% else %}
        <span class="badge badge-pending" title="ì•„ì§ ì„¸ë¶€ ê¸°íšì´ í•„ìš”í•©ë‹ˆë‹¤">ë¯¸í™•ì •</span>
        {% endif %}
    </div>
</div>

<!-- ì§„í–‰ë¥  -->
{% if total_tasks > 0 %}
<div class="detail-progress">
    <div class="detail-progress-header">
        <span class="detail-progress-label">ì‹¤ë¬´ ì§„í–‰ë¥ </span>
        <span class="detail-progress-value">{{ completed_tasks }}/{{ total_tasks }} ({{ progress }}%)</span>
    </div>
    <div class="progress-bar" title="ì™„ë£Œëœ ì‹¤ë¬´ / ì „ì²´ ì‹¤ë¬´">
        <div class="progress-fill" style="width: {{ progress }}%"></div>
    </div>
</div>
{% endif %}

<!-- ì„¸ë¶€ë‚´ìš© -->
{% if schedule.details %}
<div class="section">
    <div class="section-header">
        <div class="section-title">ğŸ“‹ ì„¸ë¶€ë‚´ìš©</div>
    </div>
    <div class="wysiwyg-content">{{ schedule.details | safe }}</div>
</div>
{% endif %}

<!-- ì•„ì´ë””ì–´ (ì‹¤ë¬´ ìœ„ì— ë°°ì¹˜) -->
<div class="section">
    <div class="section-header">
        <div class="section-title">ğŸ’¡ ì•„ì´ë””ì–´</div>
        <span class="section-hint">ì‹¤ë¬´ê°€ ì•„ë‹Œ ì œì•ˆì‚¬í•­</span>
    </div>
    <p class="section-description">ì´ ì¼ì •ì˜ ì„¸ë¶€ë‚´ìš©ì— ëŒ€í•œ ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ì¶”ê°€í•´ì£¼ì„¸ìš”. íšŒì˜ì—ì„œ ë…¼ì˜ í›„ ì„¸ë¶€ë‚´ìš©ì— ë°˜ì˜í•©ë‹ˆë‹¤.</p>

    {% if idea_tasks %}
    <ul class="task-list">
        {% for task in idea_tasks %}
        <li class="task-item {% if task.is_completed %}completed{% endif %}" data-task-id="{{ task.id }}">
            <button type="button" class="checkbox-btn {% if task.is_completed %}checked{% endif %}" onclick="toggleTask({{ task.id }}, this)" title="ì±„íƒ ì—¬ë¶€ í‘œì‹œ">
                {% if task.is_completed %}âœ“{% endif %}
            </button>
            <div class="task-content">
                <div class="task-text">{{ task.content }}</div>
                <div class="task-meta">
                    {% if task.activist_name %}
                    <span class="assignee" title="ì œì•ˆì">{{ task.activist_name }}</span>
                    {% endif %}
                    {% if task.created_at %}
                    <span class="created-date" title="ì œì•ˆ ì¼ì‹œ">{{ task.created_at }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="task-actions">
                <button type="button" class="btn btn-ghost btn-sm" onclick="openEditModal({{ task.id }}, `{{ task.content | replace('`', '\\`') | replace('\n', '\\n') }}`, '{{ task.activist_id or '' }}', '', 0, true)">ìˆ˜ì •</button>
                <form action="{{ url_for('task_delete', task_id=task.id) }}" method="post" class="inline-form"
                      onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit" class="btn btn-danger btn-sm">ì‚­ì œ</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="empty-state small">
        <span class="text-muted">ì•„ì§ ì œì•ˆëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</span>
    </div>
    {% endif %}

    <!-- ì•„ì´ë””ì–´ ì¶”ê°€ í¼ -->
    <form action="{{ url_for('task_add') }}" method="post" class="add-form" title="ì„¸ë¶€ë‚´ìš© ì•„ì´ë””ì–´ ì¶”ê°€">
        <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
        <input type="hidden" name="referer" value="{{ request.url }}">
        <input type="hidden" name="is_idea" value="1">
        <input type="text" name="content" placeholder="+ ì„¸ë¶€ë‚´ìš© ì•„ì´ë””ì–´ ì¶”ê°€... (ì˜ˆ: í¬ìŠ¤í„° ë””ìì¸ì— ë¬´ì§€ê°œ ê¹ƒë°œ ë„£ê¸°)" required>
        <select name="activist_id" class="form-control" style="width: auto;" title="ëˆ„ê°€ ì œì•ˆí–ˆë‚˜ìš”?">
            <option value="">ë¯¸ì •</option>
            {% for activist in activists %}
            <option value="{{ activist.id }}">{{ activist.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary btn-sm">ì¶”ê°€</button>
    </form>
</div>

<!-- ì‹¤ë¬´ -->
<div class="section">
    <div class="section-header">
        <div class="section-title">ğŸ“ ì‹¤ë¬´</div>
        <span class="section-hint">ì‹¤ì œë¡œ í•´ì•¼ í•  ì¼</span>
    </div>
    <p class="section-description">ì´ ì¼ì •ì„ ìœ„í•´ í•´ì•¼ í•  ì‹¤ë¬´ ëª©ë¡ì…ë‹ˆë‹¤. ì²´í¬ë°•ìŠ¤ë¥¼ ëˆŒëŸ¬ ì™„ë£Œ ì²˜ë¦¬í•˜ì„¸ìš”.</p>

    {% if action_tasks %}
    <ul class="task-list">
        {% for task in action_tasks %}
        <li class="task-item {% if task.is_completed %}completed{% endif %}" data-task-id="{{ task.id }}">
            <button type="button" class="checkbox-btn {% if task.is_completed %}checked{% endif %}" onclick="toggleTask({{ task.id }}, this)" title="í´ë¦­í•˜ì—¬ ì™„ë£Œ/ë¯¸ì™„ë£Œ ì „í™˜">
                {% if task.is_completed %}âœ“{% endif %}
            </button>
            <div class="task-content">
                <div class="task-text">
                    {% if task.is_draft %}<span class="badge badge-draft" title="ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ì‹¤ë¬´ (íšŒì˜ì—ì„œ ê²°ì • í•„ìš”)">ê°€ì•ˆ</span> {% endif %}
                    {{ task.content }}
                </div>
                <div class="task-meta">
                    {% if task.deadline %}
                    <span class="deadline-date">{{ task.deadline | date_kr }}</span>
                    <span class="dday {{ task.deadline | dday_class }}">{{ task.deadline | dday }}</span>
                    {% endif %}
                    <span class="assignee {% if not task.activist_name %}unassigned{% endif %}" title="ë‹´ë‹¹ì">{{ task.activist_name or 'ë¯¸ì •' }}</span>
                </div>
            </div>
            <div class="task-actions">
                <button type="button" class="btn btn-ghost btn-sm" onclick="openEditModal({{ task.id }}, `{{ task.content | replace('`', '\\`') | replace('\n', '\\n') }}`, '{{ task.activist_id or '' }}', '{{ task.deadline or '' }}', {{ task.is_draft }}, false)">ìˆ˜ì •</button>
                <form action="{{ url_for('task_delete', task_id=task.id) }}" method="post" class="inline-form"
                      onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit" class="btn btn-danger btn-sm">ì‚­ì œ</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="empty-state small">
        <span class="text-muted">ë“±ë¡ëœ ì‹¤ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</span>
    </div>
    {% endif %}

    <!-- ì¸ë¼ì¸ ì¶”ê°€ í¼ -->
    <form action="{{ url_for('task_add') }}" method="post" class="add-form" title="ìƒˆ ì‹¤ë¬´ ì¶”ê°€">
        <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
        <input type="hidden" name="referer" value="{{ request.url }}">
        <input type="text" name="content" placeholder="+ ì‹¤ë¬´ ì¶”ê°€... (ì˜ˆ: ì¥ì†Œ ëŒ€ê´€í•˜ê¸°)" required>
        <select name="activist_id" class="form-control" style="width: auto;" title="ëˆ„ê°€ ë‹´ë‹¹í•˜ë‚˜ìš”?">
            <option value="">ë¯¸ì •</option>
            {% for activist in activists %}
            <option value="{{ activist.id }}">{{ activist.name }}</option>
            {% endfor %}
        </select>
        <input type="date" name="deadline" class="form-control" style="width: auto;" title="ì–¸ì œê¹Œì§€ ì™„ë£Œí•´ì•¼ í•˜ë‚˜ìš”?">
        <label class="form-check" style="margin: 0; white-space: nowrap;" title="ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ì‹¤ë¬´ì¸ ê²½ìš° ì²´í¬">
            <input type="checkbox" name="is_draft" value="1">
            ê°€ì•ˆ
        </label>
        <button type="submit" class="btn btn-primary btn-sm">ì¶”ê°€</button>
    </form>
</div>

<!-- í•˜ë‹¨ ë„ì›€ë§ -->
<div class="page-footer-hint">
    <div class="hint-item">
        <span class="badge badge-draft">ê°€ì•ˆ</span> ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ì‹¤ë¬´. íšŒì˜ì—ì„œ ê²°ì • í›„ ê°€ì•ˆì„ í•´ì œí•˜ì„¸ìš”.
    </div>
    <div class="hint-item">
        <span class="badge badge-idea">ì•„ì´ë””ì–´</span> ì„¸ë¶€ë‚´ìš©ì— ëŒ€í•œ ì•„ì´ë””ì–´. íšŒì˜ì—ì„œ ë…¼ì˜ í›„ ë°˜ì˜í•˜ì„¸ìš”.
    </div>
</div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeEditModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">ì‹¤ë¬´ ìˆ˜ì •</h3>
            <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm" method="post">
            <div class="modal-body">
                <div class="form-group">
                    <label>ë‚´ìš©</label>
                    <input type="text" name="content" id="editContent" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>ë‹´ë‹¹ì</label>
                    <select name="activist_id" id="editActivist" class="form-control">
                        <option value="">ë¯¸ì •</option>
                        {% for activist in activists %}
                        <option value="{{ activist.id }}">{{ activist.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" id="deadlineGroup">
                    <label>ë§ˆê°ì¼</label>
                    <input type="date" name="deadline" id="editDeadline" class="form-control">
                </div>
                <div class="form-group" id="draftGroup">
                    <label class="form-check">
                        <input type="checkbox" name="is_draft" id="editDraft" value="1">
                        ê°€ì•ˆ (ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ì‹¤ë¬´)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}
.modal-content {
    position: relative;
    background: var(--bg-main);
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}
.modal-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}
.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
}
.modal-body {
    padding: 20px;
}
.modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}
.form-group {
    margin-bottom: 16px;
}
.form-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
    color: var(--text-secondary);
}
</style>

<script>
function openEditModal(taskId, content, activistId, deadline, isDraft, isIdea) {
    document.getElementById('editForm').action = `/task/${taskId}/edit`;
    document.getElementById('editContent').value = content;
    document.getElementById('editActivist').value = activistId || '';
    document.getElementById('editDeadline').value = deadline || '';
    document.getElementById('editDraft').checked = isDraft == 1;

    // ì•„ì´ë””ì–´ì¸ ê²½ìš° ë§ˆê°ì¼ê³¼ ê°€ì•ˆ ì˜µì…˜ ìˆ¨ê¸°ê¸°
    document.getElementById('deadlineGroup').style.display = isIdea ? 'none' : 'block';
    document.getElementById('draftGroup').style.display = isIdea ? 'none' : 'block';

    document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
    }
});
</script>
{% endblock %}
