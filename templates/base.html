<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{% block title %}ë¶€ì‚°í€´ì–´í–‰ë™{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="header">
        <div class="header-inner">
            <a href="{{ url_for('index') }}" class="header-title">ë¶€ì‚°í€´ì–´í–‰ë™ TODO</a>
            {% if current_user.is_authenticated %}
            <div class="header-user">
                {% if current_user.picture %}
                <img src="{{ current_user.picture }}" alt="" class="avatar">
                {% else %}
                <span class="avatar">{{ current_user.name[0] if current_user.name else '?' }}</span>
                {% endif %}
                <div class="user-menu">
                    <div class="user-menu-content">
                        <div class="user-menu-name">{{ current_user.name or current_user.email }}</div>
                        <div class="user-menu-link">
                            <form action="{{ url_for('link_activist') }}" method="post" class="link-activist-form">
                                <label>ë‚´ í™œë™ê°€</label>
                                <select name="activist_id" onchange="this.form.submit()">
                                    <option value="">ì—°ê²° ì•ˆí•¨</option>
                                    {% for activist in all_activists %}
                                    <option value="{{ activist.id }}" {% if current_user.activist_id==activist.id
                                        %}selected{% endif %}>{{ activist.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="menu-help">ì—°ê²°í•˜ë©´ ë‚´ TODOê°€ ë¨¼ì € í‘œì‹œë¼ìš”</small>
                            </form>
                        </div>
                        <a href="{{ url_for('activists') }}">í™œë™ê°€ ê´€ë¦¬</a>
                        <a href="{{ url_for('admin_users') }}">ì‚¬ìš©ì ê´€ë¦¬</a>
                        <a href="{{ url_for('logout') }}" class="logout">ë¡œê·¸ì•„ì›ƒ</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </header>

    <!-- ë©”ì¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="tab-nav">
        <div class="tab-nav-inner">
            <a href="{{ url_for('index') }}" class="tab-item {% if request.endpoint == 'index' %}active{% endif %}">
                <span class="tab-icon">ğŸ“‹</span>
                <span>TODO</span>
            </a>
            <a href="{{ url_for('schedules') }}"
                class="tab-item {% if request.endpoint in ['schedules', 'schedule_detail', 'schedule_add', 'schedule_edit'] %}active{% endif %}">
                <span class="tab-icon">ğŸ“…</span>
                <span>ì¼ì •</span>
            </a>
        </div>
    </nav>

    <!-- í”Œë˜ì‹œ ë©”ì‹œì§€ -->
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="toast-area">
        {% for message in messages %}
        <div
            class="toast {% if 'ì…ë ¥' in message or 'ì„ íƒ' in message or 'ì˜¬ë°”ë¥´ì§€' in message or 'ì—†ìŠµë‹ˆë‹¤' in message or 'ì‹¤íŒ¨' in message %}error{% endif %}">
            {{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main">
        {% block content %}{% endblock %}
    </main>

    <script>
        // ì²´í¬ë°•ìŠ¤ í† ê¸€
        function toggleTask(taskId, btn) {
            const item = btn.closest('.task-row');

            fetch(`/task/${taskId}/toggle`, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (data.new_status === 1) {
                            item.classList.add('done');
                            btn.textContent = 'âœ“';
                        } else {
                            item.classList.remove('done');
                            btn.textContent = '';
                        }
                    }
                })
                .catch(() => location.reload());
        }

        // í† ìŠ¤íŠ¸ ìë™ ìˆ¨ê¹€
        document.querySelectorAll('.toast').forEach(toast => {
            setTimeout(() => toast.remove(), 3000);
        });

        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥/ë³µì›
        const scrollKey = 'scroll_' + location.pathname;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
        if (sessionStorage.getItem(scrollKey)) {
            const savedScroll = parseInt(sessionStorage.getItem(scrollKey));
            // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë³µì› (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
            requestAnimationFrame(() => {
                window.scrollTo(0, savedScroll);
            });
        }

        // ë§í¬ í´ë¦­ ì‹œ í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href && !link.href.startsWith('javascript:')) {
                sessionStorage.setItem(scrollKey, window.scrollY);
            }
        });

        // ë’¤ë¡œê°€ê¸° ì‹œ ìŠ¤í¬ë¡¤ ë³µì› (popstate)
        window.addEventListener('pageshow', (e) => {
            if (e.persisted || performance.getEntriesByType('navigation')[0]?.type === 'back_forward') {
                const saved = sessionStorage.getItem(scrollKey);
                if (saved) {
                    window.scrollTo(0, parseInt(saved));
                }
            }
        });
    </script>
</body>

</html>